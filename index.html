<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Home Dashboard</title>
    <!-- REMOVED: Tailwind CSS CDN -->
    
    <!-- NEW: Add Chart.js CDN (v3.9.1) - This is old enough to be compatible -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Use Inter font family -->
    <style>
        /* Manually import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- START: Manual CSS Rewrite (Replaces Tailwind) --- */
        
        /* Reset and Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            /* Hardcoded background color (was CSS var) */
            background-color: #0b1118; 
            /* Optional: subtle background gradient for depth */
            background-image: radial-gradient(at 0% 0%, #1a2b4b 0%, transparent 50%), 
                              radial-gradient(at 100% 100%, #1e1b4b 0%, transparent 50%);
            color: #e5e7eb; /* Light gray text */
            padding: 1rem; /* Replaces p-4 */
        }
        
        /* Main container */
        .container {
            max-width: 80rem; /* Replaces max-w-4xl */
            margin-left: auto;
            margin-right: auto;
        }

        /* Spacing for children of .container */
        .container > * + * {
            margin-top: 1.5rem; /* Replaces space-y-6 */
        }

        /* Header */
        .header {
            margin-bottom: 1.5rem; /* Replaces mb-6 */
            margin-top: 0.5rem; /* Replaces mt-2 */
            padding-bottom: 1rem; /* Replaces pb-4 */
        }
        
        .header h1 {
            font-size: 2.25rem; /* Replaces text-4xl */
            line-height: 2.5rem;
            font-weight: 300; /* Replaces font-light */
            color: #7dd3fc; /* Replaces text-cyan-300 */
        }

        .header #clock-display {
            font-size: 3rem; /* Replaces text-5xl */
            line-height: 1;
            font-weight: 800; /* Replaces font-extrabold */
            color: #ffffff; /* Replaces text-white */
            margin-top: 0.5rem; /* Replaces mt-2 */
        }

        .header #date-display {
            font-size: 1rem; /* Replaces text-md */
            line-height: 1.5rem;
            color: #9ca3af; /* Replaces text-gray-400 */
            margin-top: 0.25rem; /* Replaces mt-1 */
        }

        /* Card Grid (Replaces CSS Grid with Float Layout) */
        .card-grid {
            margin-left: -0.75rem;
            margin-right: -0.75rem;
        }
        /* Clearfix to contain floats */
        .card-grid:after {
            content: "";
            display: table;
            clear: both;
        }

        .card-column {
            width: 100%; /* Mobile default */
            float: left;
            padding: 0.75rem; /* Emulates gap-6 */
        }
        
        /* Spacing for cards in the first column */
        .card-column > * + * {
             margin-top: 1.5rem; /* Replaces space-y-6 */
        }

        /* Tablet Breakpoint */
        @media (min-width: 768px) {
            .card-column {
                width: 50%; /* 2 columns */
            }
            /* Tide graph becomes full width on tablet */
            #tide-graph-container {
                width: 100%;
            }
        }
        
        /* Desktop Breakpoint */
        @media (min-width: 1024px) {
            .card-column {
                width: 33.333%; /* 3 columns */
            }
            /* Tide graph goes back to 1/3 width */
            #tide-graph-container {
                width: 33.333%;
            }
        }
        
        /* Glass Card Style */
        .glass-card {
            /* Hardcoded glass-card styles */
            background-color: rgba(30, 41, 59, 0.45); 
            border: 1px solid rgba(107, 114, 128, 0.2); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 2px 2px rgba(255, 255, 255, 0.1); 
            padding: 1.5rem; /* Replaces p-6 */
            border-radius: 1.5rem; /* Replaces rounded-3xl */
            /* REMOVED: backdrop-filter: blur(16px); */
            /* REMOVED: -webkit-backdrop-filter: blur(16px); */
        }

        /* Bus card is full width */
        .bus-card-container {
            margin-top: 1.5rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            font-size: 0.875rem; /* Replaces text-sm */
            line-height: 1.25rem;
            color: #6b7280; /* Replaces text-gray-500 */
            padding-top: 1rem; /* Replaces pt-4 */
        }
        .footer p + p {
            margin-top: 0.25rem; /* Replaces mt-1 */
        }

        /* --- End: Manual CSS Rewrite --- */


        /* Custom scrollbar (already compatible) */
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Bus list item striping (already compatible) */
        .bus-item:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Accordion Styling (already compatible) */
        .tide-accordion summary {
            cursor: pointer;
            outline: none;
            list-style: none; /* Hide default arrow */
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tide-accordion summary::-webkit-details-marker {
            display: none; /* Hide default arrow in webkit */
        }
        
        .tide-accordion summary .arrow-indicator {
            transition: transform 0.2s;
            color: #7dd3fc;
            width: 1.5rem;
            height: 1.5rem;
            text-align: center;
            flex-shrink: 0;
            margin-left: 0.75rem;
        }
        .tide-accordion[open] summary .arrow-indicator {
            transform: rotate(180deg);
        }
        
        /* Canvas specific styling */
        #tide-graph-canvas {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 10px;
            max-height: 200px; 
        }

        /* --- SKELETON LOADER STYLES (Manual) --- */
        .skeleton {
            margin-top: 1rem;
        }
        .skeleton-pulse {
             animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .skeleton .line-1 { height: 3rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; width: 50%; margin-bottom: 0.5rem; }
        .skeleton .line-2 { height: 1.5rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; width: 75%; margin-bottom: 0.75rem; }
        .skeleton .line-3 { height: 1rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; width: 33.333%; }
        .skeleton .line-4 { height: 1.25rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; width: 100%; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid rgba(107, 114, 128, 0.3); }

        /* Skeleton for forecast */
        .forecast-skeleton {
            display: flex;
            overflow-x: auto;
        }
        .forecast-skeleton-item {
            flex-shrink: 0;
            width: 9rem;
            height: 8rem;
            background-color: rgba(107, 114, 128, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-right: 1rem;
        }
        .forecast-skeleton-item .line {
            background-color: rgba(107, 114, 128, 0.5);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        /* Skeleton for bus */
        .bus-skeleton-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background-color: rgba(30, 41, 59, 0.45);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .bus-skeleton-item .left { display: flex; align-items: center; flex: 1; }
        .bus-skeleton-item .icon { height: 2rem; width: 2.5rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; }
        .bus-skeleton-item .text { flex: 1; margin-left: 1rem; }
        .bus-skeleton-item .line { background-color: rgba(107, 114, 128, 0.3); border-radius: 0.375rem; }
        .bus-skeleton-item .line-1 { height: 1rem; width: 75%; margin-bottom: 0.5rem; }
        .bus-skeleton-item .line-2 { height: 0.75rem; width: 50%; }
        .bus-skeleton-item .right { height: 1.75rem; width: 5rem; background-color: rgba(107, 114, 128, 0.3); border-radius: 9999px; }


        /* --- CARD HEADER STYLES (Manual) --- */
        .card-header-title {
            font-size: 1.25rem; /* text-xl */
            line-height: 1.75rem;
            font-weight: 700; /* font-bold */
            color: #7dd3fc; /* text-cyan-400 */
        }
        .card-header-title span {
            font-weight: 400; /* font-normal */
            color: #ffffff; /* text-white */
        }
        .card-header-icon {
            width: 2.5rem; /* w-10 */
            height: 2.5rem; /* h-10 */
            margin-right: 0.5rem; /* mr-2 */
        }
        .card-header-icon-group {
            display: flex;
            align-items: center;
        }
        .card-header-arrow {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            color: #7dd3fc; /* text-cyan-300 */
        }
        .tide-accordion[open] .card-header-arrow {
            transform: rotate(180deg);
        }
        .card-header-subtitle {
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
            color: #6b7280; /* text-gray-500 */
        }
        
        /* --- CARD CONTENT STYLES (Manual) --- */
        .card-content {
            padding-top: 1rem; /* pt-4 */
        }
        .data-main {
            font-size: 3rem; /* text-5xl */
            line-height: 1;
            font-weight: 800; /* font-extrabold */
            margin-bottom: 0.25rem; /* mb-1 */
            color: #ffffff; /* text-white */
        }
        .data-sub {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
            color: #e5e7eb; /* text-gray-200 */
        }
        .data-detail {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            color: #9ca3af; /* text-gray-400 */
            margin-top: 0.5rem; /* mt-2 */
        }

        /* Forecast card specific */
        #forecast-list-container {
            /* display: none; */ /* Handled by JS */
        }
        #forecast-list {
            display: flex;
            overflow-x: auto;
        }
        .forecast-item {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 0.75rem; /* p-3 */
            width: 10rem; /* w-40 */
            height: 8rem; /* h-32 */
            background-color: rgba(51, 65, 85, 0.4); /* bg-slate-800/40 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-right: 0.75rem; /* space-x-3 */
            /* Glass card styles */
            background-color: rgba(30, 41, 59, 0.45); 
            border: 1px solid rgba(107, 114, 128, 0.2); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 2px 2px rgba(255, 255, 255, 0.1);
        }
        .forecast-item p {
            font-size: 0.875rem; /* text-sm */
            font-weight: 700; /* font-bold */
            color: #7dd3fc; /* text-cyan-300 */
        }
        .forecast-item ul {
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.375rem; /* space-y-1.5 */
        }
        .forecast-item ul li {
            margin-top: 0.375rem;
        }
        .forecast-item ul li .font-medium {
            font-weight: 500;
        }
        .forecast-item .text-blue-300 { color: #93c5fd; }
        .forecast-item .text-gray-400 { color: #9ca3af; }
        .forecast-item .text-green-300 { color: #86efac; }
        .forecast-item .text-yellow-300 { color: #fde047; }


        /* Bus card specific */
        #bus-info-header {
            margin-bottom: 1rem; /* mb-4 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 1px solid rgba(107, 114, 128, 0.3); /* border-b border-gray-600/50 */
        }
        #bus-info-header p {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-500 */
            margin-top: 0.25rem; /* mt-1 */
        }
        .bus-list-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 300; /* font-light */
            color: #7dd3fc; /* text-cyan-300 */
            margin-bottom: 1rem; /* mb-4 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 1px solid rgba(107, 114, 128, 0.3); /* border-b border-gray-600/50 */
        }
        #bus-list {
            overflow-y: auto;
            max-height: 24rem; /* max-h-96 */
        }
        #bus-list > * + * {
            margin-top: 0.25rem; /* space-y-1 */
        }
        .bus-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem; /* p-3 */
            background-color: rgba(30, 41, 59, 0.45);
            border: 1px solid rgba(107, 114, 128, 0.2); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 2px 2px rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .bus-item-left {
            display: flex;
            align-items: center;
        }
        .bus-item-left .line-name {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 800; /* font-extrabold */
            color: #b0e0f6; /* text-cyan-200 */
            width: 2.5rem; /* w-10 */
            text-align: center;
            margin-right: 1rem; /* space-x-4 */
        }
        .bus-item-left .line-dest {
            color: #ffffff; /* text-white */
            font-weight: 500; /* font-medium */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bus-item-left .line-platform {
            font-size: 0.75rem; /* text-xs */
            color: #9ca3af; /* text-gray-400 */
        }
        .bus-item-time {
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem;
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem;
            font-size: 0.875rem; /* text-sm */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            flex-shrink: 0;
        }
        /* Time colors (manual) */
        .bg-red-500-70 { background-color: rgba(239, 68, 68, 0.7); }
        .text-white-bold-pulse { color: #ffffff; font-weight: 800; animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .bg-yellow-500-70 { background-color: rgba(234, 179, 8, 0.7); }
        .text-gray-900-bold { color: #111827; font-weight: 700; }
        .bg-indigo-600-70 { background-color: rgba(79, 70, 229, 0.7); }
        .text-white-bold { color: #ffffff; font-weight: 700; }

        /* Tide graph styles */
        #tide-graph-accordion summary {
            border-bottom: 1px solid rgba(107, 114, 128, 0.3); /* border-b border-gray-600/50 */
            padding-bottom: 0.5rem; /* pb-2 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #tide-graph-container .card-content {
            padding-top: 0.5rem; /* pt-2 */
        }
        .chart-tooltip {
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* text-gray-600 */
            margin-top: 0.25rem; /* mt-1 */
            text-align: center;
        }
        
        /* Error messages */
        .error-text {
            color: #f87171; /* text-red-300 */
        }
        .error-message {
            display: none;
            color: #f87171; /* text-red-300 */
            font-size: 0.875rem;
            font-weight: 700;
        }
        .error-card-bg {
             background-color: rgba(127, 29, 29, 0.5); /* bg-red-900/50 */
        }
        /* Hide helper */
        .hidden {
            display: none;
        }

    </style>
</head>
<body class="p-4 md:p-8"> <!-- Classes kept for context, but styles are manual -->

    <div class="container">
        
        <!-- Header -->
        <div class="header">
            <div>
                <h1>London At A Glance</h1>
                <p id="clock-display">--:--</p>
                <p id="date-display">--</p>
            </div>
        </div>
        
        <!-- Grid Container -->
        <div class="card-grid">

            <!-- Column 1 Wrapper -->
            <div class="card-column">
                
                <!-- 1. Weather Card -->
                <div id="weather-card" class="glass-card">
                    <details class="tide-accordion" open>
                        <summary>
                            <h2 class="card-header-title">Current Weather</h2>
                            <div class="card-header-icon-group">
                                <svg id="weather-icon" class="card-header-icon" style="color: #fde047;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                <svg class="card-header-arrow arrow-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </summary>
                        
                        <div class="card-content">
                            <!-- SKELETON LOADER -->
                            <div id="weather-loading" class="skeleton skeleton-pulse">
                                <div class="line-1"></div>
                                <div class="line-2"></div>
                                <div class="line-3"></div>
                            </div>
                            
                            <div id="weather-data" class="hidden">
                                <p class="data-main"><span id="temp-display">--</span>°C</p>
                                <p class="data-sub"><span id="condition-display">--</span></p>
                                <p class="data-detail">Wind: <span id="wind-display">--</span> mph</p>
                            </div>
                        </div>
                    </details>
                </div>
                <!-- END 1. Weather Card -->

                <!-- 2. 24-Hour Advice Card -->
                <div id="forecast-card" class="glass-card">
                    <details class="tide-accordion" open>
                        <summary>
                            <h2 class="card-header-title">24-Hour Advice</h2>
                            <div class="card-header-icon-group">
                                <svg class="card-header-icon" style="color: #7dd3fc;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 6 C9 4, 15 4, 15 6 L 17.5 6 A 1.5 1.5 0 0 1 19 7.5 L 19 19.5 A 1.5 1.5 0 0 1 17.5 21 L 6.5 21 A 1.5 1.5 0 0 1 5 19.5 L 5 7.5 A 1.5 1.5 0 0 1 6.5 6 L 9 6" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6 L 12 21" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 15 Q 9 17 10 15" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M14 15 Q 15 17 16 15" />
                                </svg>
                                <svg class="card-header-arrow arrow-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </summary>
                        
                        <div class="card-content">
                            <!-- SKELETON LOADER -->
                            <div id="forecast-loading" class="forecast-skeleton skeleton-pulse no-scrollbar">
                                <div class="forecast-skeleton-item">
                                    <div class="line" style="height: 1rem; width: 33%;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%; margin-top: 0.75rem;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%;"></div>
                                </div>
                                <div class="forecast-skeleton-item">
                                    <div class="line" style="height: 1rem; width: 33%;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%; margin-top: 0.75rem;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%;"></div>
                                    <div class="line" style="height: 0.75rem; width: 100%;"></div>
                                </div>
                            </div>
                            
                            <!-- Forecast Data Container -->
                            <div id="forecast-list-container" class="hidden">
                                <div id="forecast-list" class="no-scrollbar">
                                    <!-- Advice items will be injected here -->
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                <!-- END 2. 24-Hour Advice Card -->
            </div>
            <!-- END Column 1 Wrapper -->

            <!-- 3. Thames Tide Level Card -->
            <div id="tide-card" class="card-column">
                <div class="glass-card">
                    <details class="tide-accordion" open>
                        <summary>
                            <div>
                                <h2 class="card-header-title">Thames Water Level</h2>
                                <p id="tide-station-name" class="card-header-subtitle">--</p>
                            </div>
                            <div class="card-header-icon-group">
                                <svg id="tide-icon" class="card-header-icon" style="color: #60a5fa;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 8s3-4 6-4 6 4 6 4 6-4 6-4M2 14s3-4 6-4 6 4 6 4 6-4 6-4M2 20s3-4 6-4 6 4 6 4 6-4 6-4"/>
                                </svg>
                                <svg class="card-header-arrow arrow-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </summary>

                        <div class="card-content">
                            <!-- SKELETON LOADER -->
                            <div id="tide-loading" class="skeleton skeleton-pulse">
                                <div class="line-1"></div>
                                <div class="line-2"></div>
                                <div class="line-3"></div>
                                <div class="line-4"></div>
                            </div>
                            
                            <div id="tide-data" class="hidden">
                                <p class="data-main"><span id="tide-level">--</span> m</p>
                                <p class="data-sub" id="tide-status">--</p>
                                <p class="data-detail">Last reading: <span id="tide-time">--</span></p>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            <!-- END 3. Thames Tide Level Card -->

            <!-- 4. Tide Graph Card -->
            <div id="tide-graph-container" class="card-column">
                <div class="glass-card">
                    <details id="tide-graph-accordion" open class="tide-accordion">
                        <summary>
                            <span class="card-header-title">48-Hour Tide Graph</span>
                            <div class="card-header-icon-group">
                                <svg class="card-header-icon" style="color: #7dd3fc;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                  <path fill-rule="evenodd" d="M2.25 13.5a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75v6.75a.75.75 0 0 1-1.5 0v-5.5L2.25 13.5ZM9.75 5.25a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75v15a.75.75 0 0 1-1.5 0V6L9.75 5.25ZM17.25 9a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75v11.25a.75.75 0 0 1-1.5 0V9.75L17.25 9Z" clip-rule="evenodd" />
                                </svg>
                                <svg class="card-header-arrow arrow-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </summary>
                        <div class="card-content" style="padding-top: 0.5rem;">
                             <canvas id="tide-graph-canvas"></canvas>
                             <p class="chart-tooltip">Hover over the graph for details.</p>
                        </div>
                    </details>
                </div>
            </div>
            <!-- End 4. Tide Graph Card -->

        </div> <!-- End Card Grid -->

        <!-- 5. Combined Bus Departures List Card -->
        <div id="bus-list-container" class="glass-card bus-card-container">
             <details class="tide-accordion" open>
                <summary>
                    <div style="flex-grow: 1;">
                        <h2 class="card-header-title">Bus Stop: <span id="bus-stop-name-title">--</span></h2>
                        <p id="bus-status-error" class="error-message">Error</p> 
                    </div>
                    <div class="card-header-icon-group">
                        <svg class="card-header-icon" style="color: #ef4444;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M4.5 3.75A3.75 3.75 0 0 0 .75 7.5v10.5c0 .95.5 1.8 1.28 2.28L3 21.75v.938A.812.812 0 0 0 3.812 23.5h1.375a.812.812 0 0 0 .813-.812V21.75l.969-.969a3.75 3.75 0 0 0 2.28-1.28h7.103a3.75 3.75 0 0 0 2.28 1.28l.97.969v.938a.812.812 0 0 0 .812.812h1.375a.812.812 0 0 0 .813-.812v-.938l.969-.969c.78-.48 1.28-1.33 1.28-2.28V7.5A3.75 3.75 0 0 0 19.5 3.75h-15ZM4.5 6a.75.75 0 0 1 .75-.75h13.5a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V6Zm15 6a.75.75 0 0 0-.75-.75H5.25a.75.75 0 0 0-.75.75v3a.75.75 0 0 0 .75.75h13.5a.75.75 0 0 0 .75-.75v-3ZM5.625 18a1.875 1.875 0 1 0 0-3.75 1.875 1.875 0 0 0 0 3.75Zm12.75 0a1.875 1.875 0 1 0 0-3.75 1.875 1.875 0 0 0 0 3.75Z" clip-rule="evenodd" />
                        </svg>
                        <svg class="card-header-arrow arrow-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </summary>

                <div class="card-content">
                    <div id="bus-info-header">
                        <p>Stop ID: <span id="bus-stop-id">--</span></p>
                    </div>
                    
                    <h3 class="bus-list-title">Upcoming Departures</h3>
                    
                    <!-- SKELETON LOADER -->
                    <div id="bus-loading" class="skeleton-pulse">
                        <div class="bus-skeleton-item">
                            <div class="left">
                                <div class="icon"></div>
                                <div class="text">
                                    <div class="line line-1"></div>
                                    <div class="line line-2"></div>
                                </div>
                            </div>
                            <div class="right"></div>
                        </div>
                        <div class="bus-skeleton-item">
                            <div class="left">
                                <div class="icon"></div>
                                <div class="text">
                                    <div class="line line-1"></div>
                                    <div class="line line-2"></div>
                                </div>
                            </div>
                            <div class="right"></div>
                        </div>
                    </div>

                    <div id="bus-list" class="scroll-container">
                        <!-- Bus items will be injected here -->
                    </div>
                </div>
             </details>
        </div>

        <!-- Last Updated Footer -->
        <div class="footer">
            <p id="last-updated">Last updated: --</p>
            <p>Data provided by Open-Meteo, TfL, and the Environment Agency.</p>
        </div>
    </div>

    <!-- ES5-COMPATIBLE JAVASCRIPT -->
    <script>
        // --- MANDATORY CONFIGURATION SECTION ---
        var LONDON_LAT = 51.5074;
        var LONDON_LON = 0.1278;
        var TFL_PRIMARY_KEY = "9a8fd770a5804ee6b233907040c5b99d";
        var TFL_APP_ID = TFL_PRIMARY_KEY; 
        var TFL_APP_KEY = TFL_PRIMARY_KEY; 
        var TFL_NAPTAN_ID = "490006091W"; 
        var FETCH_TIMEOUT_MS = 10000;
        var EA_TIDE_STATION_ID = "0007"; 
        var tideChartInstance = null;

        // --- Robustness Check ---
        if (!TFL_NAPTAN_ID || !EA_TIDE_STATION_ID || !LONDON_LAT || !LONDON_LON || !TFL_PRIMARY_KEY) {
            console.error("CRITICAL ERROR: Configuration variables are not set.");
            document.body.innerHTML = '<div style="padding: 2rem; color: #f87171; font-family: sans-serif; font-size: 1.5rem; text-align: center; background: #111; height: 100vh; display: grid; place-items: center;">Configuration Error: Please check the JavaScript constants.</div>';
            throw new Error("Dashboard configuration is missing."); 
        }

        // --- UTILITY FUNCTIONS (ES5) ---

        /**
         * Utility to strip HTML tags (ES5 compatible)
         */
        function stripTags(str) {
            if (!str) return "";
            return str.toString().replace(/(<([^>]+)>)/gi, "");
        }
        
        /**
         * Helper to show/hide elements (ES5 compatible)
         */
        function showElement(el) {
            if (el) {
                el.style.display = 'block';
                
                // Special handling for flex containers
                if (el.id === 'forecast-list' || el.id === 'forecast-loading') {
                    el.style.display = 'flex';
                }
            }
        }
        
        function hideElement(el) {
            if (el) {
                el.style.display = 'none';
            }
        }

        /**
         * ROBUST: Upgraded helper to perform API calls (ES5 compatible)
         * Uses .then() and XHR-style timeout
         */
        function fetchData(url, errorMsg, options) {
            // Manual default parameter handling
            var options = options || {};
            var auth = options.auth || {};
            var extraHeaders = options.extraHeaders || {};
            var timeout = options.timeout || FETCH_TIMEOUT_MS;

            return new Promise(function(resolve, reject) {
                var timeoutId = setTimeout(function() {
                    reject(new Error("Request timed out (" + (timeout / 1000) + "s)."));
                }, timeout);

                // Add TfL auth parameters if provided
                if (auth.id && auth.key) {
                    url += (url.indexOf('?') > -1 ? '&' : '?') + 'app_id=' + auth.id + '&app_key=' + auth.key;
                } else if (auth.key) {
                    url += (url.indexOf('?') > -1 ? '&' : '?') + 'app_key=' + auth.key;
                }

                fetch(url, { headers: extraHeaders })
                    .then(function(response) {
                        clearTimeout(timeoutId); // Clear timeout on successful response
                        if (response.ok) {
                            return response.json();
                        } else {
                            // Create an error to be caught by .catch
                            var error = new Error(response.status + " " + (response.statusText || 'Error'));
                            error.response = response;
                            throw error;
                        }
                    })
                    .then(function(json) {
                        resolve(json); // Resolve promise with JSON data
                    })
                    .catch(function(error) {
                        clearTimeout(timeoutId); // Clear timeout on fetch error
                        console.error("[" + errorMsg + "] Fetch Error:", error.message);
                        // Resolve with an error object, so Promise.allSettled works
                        resolve({ error: error.message }); 
                    });
            });
        }

        function formatTime(timestamp) {
            var date = new Date(timestamp);
            return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function formatDateTime(isoString) {
             var date = new Date(isoString);
             return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function formatChartLabel(isoString) {
            var date = new Date(isoString);
            var time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            return time;
        }

        function updateTimeAndDate() {
            var now = new Date();
            var timeString = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            var dateString = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });

            document.getElementById('clock-display').textContent = timeString;
            document.getElementById('date-display').textContent = dateString;
        }

        function minutesToArrival(timeOfArrival) {
            var now = new Date();
            var arrival = new Date(timeOfArrival);
            var diffMs = arrival - now;
            var diffMins = Math.round(diffMs / 60000);
            return diffMins > 0 ? diffMins : 0;
        }
        
        function getWeatherDescriptionAndIcon(code) {
            var description = 'Unknown';
            var iconPath = 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z'; 
            var color = '#fde047'; // text-yellow-300
            
            if (code === 0) {
                description = 'Clear Sky';
                iconPath = 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z'; 
                color = '#fde047';
            } else if (code >= 1 && code <= 3) {
                description = (code === 1) ? 'Mainly Clear' : (code === 2) ? 'Partly Cloudy' : 'Overcast';
                iconPath = 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.782-2.09A4.004 4.004 0 003 15z'; 
                color = '#d1d5db'; // text-gray-300
            } else if (code >= 45 && code <= 48) {
                description = 'Foggy';
                iconPath = 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.782-2.09A4.004 4.004 0 003 15z';
                color = '#9ca3af'; // text-gray-400
            } else if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) {
                description = (code > 60 && code < 70) ? 'Rain' : 'Drizzle/Showers';
                iconPath = 'M14 11V9a2 2 0 00-2-2m0 0a2 2 0 00-2 2v2m2-2V7m2 4a2 2 0 002-2h-4m4 0h4a2 2 0 002-2v-2a2 2 0 00-2-2h-4a2 2 0 00-2 2v2a2 2 0 002 2zM12 21a9 9 0 100-18 9 9 0 000 18z'; 
                color = '#3b82f6'; // text-blue-500
            } else if (code >= 71 && code <= 86) {
                description = 'Snow';
                iconPath = 'M4 14v-2h2v2H4zm-1 4h2v2H3zm2-6h2v2H5zm-1 4h2v2H4zm2-4h2v2H6zm-1 4h2v2H5zM15 4h2v2h-2zM17 6h2v2h-2zm-2 2h2v2h-2zm-2-2h2v2h-2zm2-4h2v2h-2zM15 8h2v2h-2zm2 2h2v2h-2zm-2 2h2v2h-2zM15 12h2v2h-2zm-2 2h2v2h-2zm2-2h2v2h-2zM15 14h2v2h-2zm-2 2h2v2h-2z'; 
                color = '#ffffff'; // text-white
            } else if (code >= 95) {
                description = 'Thunderstorm';
                iconPath = 'M13 14H9m0 0h4v-3a2 2 0 114 0v3h-4m-4 0v2m0 0h-4a2 2 0 11-2-2V7a2 2 0 112-2h4a2 2 0 012 2v2m-4 5V9m4 0v5m4-5v2'; 
                color = '#b45309'; // text-yellow-700
            }
            
            return { description: description, iconPath: iconPath, color: color };
        }


        // --- DATA FETCHING FUNCTIONS (ES5) ---

        function displayAdvice(hourly) {
            var loadingDiv = document.getElementById('forecast-loading');
            var listContainer = document.getElementById('forecast-list-container');
            var listDiv = document.getElementById('forecast-list');

            if (!hourly || !hourly.time || !hourly.time.length) {
                hideElement(loadingDiv);
                showElement(listContainer);
                listDiv.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">Advice data unavailable.</p>';
                return;
            }

            try {
                listDiv.innerHTML = ''; // Clear previous forecast
                var now = new Date();
                
                var startIndex = -1;
                for (var j = 0; j < hourly.time.length; j++) {
                    if (new Date(hourly.time[j]) > now) {
                        startIndex = j;
                        break;
                    }
                }
                
                if (startIndex === -1) {
                    throw new Error("No future forecast data found.");
                }

                for (var i = 0; i < 8; i++) {
                    var dataIndex = startIndex + (i * 3);
                    if (dataIndex >= hourly.time.length) break;

                    var timeStr = hourly.time[dataIndex];
                    var time = formatTime(timeStr);
                    var temp = Math.round(hourly.temperature_2m[dataIndex]);
                    var precip_prob = hourly.precipitation_probability[dataIndex];

                    var umbrellaAdvice, umbrellaColor;
                    if (precip_prob > 0) {
                        umbrellaAdvice = 'Umbrella needed (' + precip_prob + '%)';
                        umbrellaColor = 'text-blue-300';
                    } else {
                        umbrellaAdvice = "Umbrella not needed";
                        umbrellaColor = 'text-gray-400';
                    }

                    var jacketAdvice, jacketColor;
                    if (temp > 20) {
                        jacketAdvice = "No jacket needed";
                        jacketColor = 'text-gray-400';
                    } else if (temp >= 10 && temp <= 20) {
                        jacketAdvice = "Light jacket needed";
                        jacketColor = 'text-green-300';
                    } else {
                        jacketAdvice = "Warm coat needed";
                        jacketColor = 'text-yellow-300';
                    }

                    var precip_prob_3h = (dataIndex + 1 < hourly.precipitation_probability.length) ? hourly.precipitation_probability[dataIndex + 1] : 0;
                    var precip_prob_6h = (dataIndex + 2 < hourly.precipitation_probability.length) ? hourly.precipitation_probability[dataIndex + 2] : 0;
                    
                    var footwearAdvice, footwearColor;
                    if (precip_prob > 40 || precip_prob_3h > 40 || precip_prob_6h > 40) {
                        footwearAdvice = "Consider boots (Rain likely)";
                        footwearColor = 'text-blue-300';
                    } else {
                        footwearAdvice = "Trainers okay";
                        footwearColor = 'text-gray-400';
                    }

                    // String concatenation instead of template literal
                    var adviceItemHTML = 
                        '<div class="forecast-item">' +
                            '<p>' + time + '</p>' +
                            '<ul>' +
                                '<li class="' + jacketColor + '">' +
                                    '<span class="font-medium">' + jacketAdvice + '</span> (' + temp + '°C)' +
                                '</li>' +
                                '<li class="' + umbrellaColor + '">' +
                                    '<span class="font-medium">' + umbrellaAdvice + '</span>' +
                                '</li>' +
                                '<li class="' + footwearColor + '">' +
                                    '<span class="font-medium">' + footwearAdvice + '</span>' +
                                '</li>' +
                            '</ul>' +
                        '</div>';
                    listDiv.innerHTML += adviceItemHTML;
                }
                
                hideElement(loadingDiv);
                showElement(listContainer);

            } catch (error) {
                console.error("Failed to display advice:", error);
                hideElement(loadingDiv);
                showElement(listContainer);
                listDiv.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">Error loading advice.</p>';
            }
        }

        function fetchWeather() {
            var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + LONDON_LAT + '&longitude=' + LONDON_LON + '&current=temperature_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,precipitation_probability&temperature_unit=celsius&wind_speed_unit=mph&timezone=Europe/London&forecast_days=2';
            
            var card = document.getElementById('weather-card');
            var dataDiv = document.getElementById('weather-data');
            var loadingP = document.getElementById('weather-loading'); 
            var forecastLoading = document.getElementById('forecast-loading');

            // 1. Instant Loading Feedback
            showElement(loadingP);
            hideElement(dataDiv);
            card.className = card.className.replace(' error-card-bg', ''); // Reset error
            showElement(forecastLoading);
            hideElement(document.getElementById('forecast-list-container'));

            // ES5 Promise Chain
            return fetchData(url, "Open-Meteo weather data", { timeout: 10000 })
                .then(function(result) {
                    if (result.error || !result.current) {
                        hideElement(loadingP);
                        card.className += ' error-card-bg';
                        
                        hideElement(forecastLoading);
                        showElement(document.getElementById('forecast-list-container'));
                        document.getElementById('forecast-list').innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">Forecast unavailable.</p>';
                        return; // Stop execution
                    }

                    // --- 1. Populate Current Weather ---
                    var temp = result.current.temperature_2m.toFixed(0);
                    var windSpeed = result.current.wind_speed_10m.toFixed(1); 
                    var weatherCode = result.current.weather_code;
                    var weatherInfo = getWeatherDescriptionAndIcon(weatherCode);

                    document.getElementById('temp-display').textContent = temp;
                    document.getElementById('condition-display').textContent = weatherInfo.description;
                    document.getElementById('wind-display').textContent = windSpeed;
                    
                    var weatherIcon = document.getElementById('weather-icon');
                    weatherIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + weatherInfo.iconPath + '"></path>';
                    weatherIcon.style.color = weatherInfo.color;
                    
                    hideElement(loadingP);
                    showElement(dataDiv);

                    // --- 3. Populate Advice ---
                    displayAdvice(result.hourly);
                });
        }

        function fetchBusDepartures() {
            var url = 'https://api.tfl.gov.uk/StopPoint/' + TFL_NAPTAN_ID + '/Arrivals?timestamp=' + Date.now();
            var auth = { id: TFL_APP_ID, key: TFL_APP_KEY };
            
            var listDiv = document.getElementById('bus-list');
            var loadingP = document.getElementById('bus-loading'); 
            var busListContainer = document.getElementById('bus-list-container');
            var errorP = document.getElementById('bus-status-error');
            var busStopTitleSpan = document.getElementById('bus-stop-name-title');
            var busStopIdSpan = document.getElementById('bus-stop-id');
            
            // 1. Instant Loading Feedback
            showElement(loadingP);
            listDiv.innerHTML = '';
            hideElement(errorP);
            busListContainer.className = busListContainer.className.replace(' error-card-bg', '');
            
            busStopIdSpan.textContent = TFL_NAPTAN_ID;
            busStopTitleSpan.textContent = 'Fetching...';

            var busHeaders = {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            };

            return fetchData(url, "TfL Bus data", {
                auth: auth,
                extraHeaders: busHeaders,
                timeout: FETCH_TIMEOUT_MS 
            })
            .then(function(result) {
                if (result.error) {
                    console.error("Bus Data Failed:", result.error); 
                    hideElement(loadingP);
                    listDiv.innerHTML = '<p class="error-text">Could not retrieve schedule.</p>';
                    busStopTitleSpan.textContent = 'Error';
                    errorP.textContent = 'Status: ' + result.error;
                    showElement(errorP);
                    busListContainer.className += ' error-card-bg';
                    return;
                }
                
                var arrivals = result.sort(function(a, b) { return a.timeToStation - b.timeToStation; });

                if (arrivals.length === 0) {
                    hideElement(loadingP);
                    listDiv.innerHTML = '<p style="color: #6b7280;">No scheduled departures found.</p>';
                    busStopTitleSpan.textContent = 'Stop ' + TFL_NAPTAN_ID; 
                    return;
                }

                var stationName = arrivals[0].stationName || ('Stop ' + TFL_NAPTAN_ID);
                busStopTitleSpan.textContent = stripTags(stationName);

                arrivals.slice(0, 10).forEach(function(bus) {
                    var arrivalMins = minutesToArrival(bus.expectedArrival);
                    
                    var timeText;
                    var timeClass;

                    if (arrivalMins <= 1) {
                        timeText = 'NOW';
                        timeClass = 'bg-red-500-70 text-white-bold-pulse';
                    } else if (arrivalMins <= 5) {
                        timeText = arrivalMins + ' min';
                        timeClass = 'bg-yellow-500-70 text-gray-900-bold';
                    } else {
                        timeText = arrivalMins + ' min';
                        timeClass = 'bg-indigo-600-70 text-white-bold';
                    }

                    var safeDestination = stripTags(bus.destinationName);
                    var safePlatform = stripTags(bus.platformName) || 'N/A';
                    var safeLineName = stripTags(bus.lineName);

                    // String concatenation for bus item
                    var busItem = 
                        '<div class="bus-item">' +
                            '<div class="bus-item-left">' +
                                '<span class="line-name">' + safeLineName + '</span>' +
                                '<div>' +
                                    '<p class="line-dest">' + safeDestination + '</p>' +
                                    '<p class="line-platform">Platform: ' + safePlatform + '</p>' +
                                '</div>' +
                            '</div>' +
                            '<span class="bus-item-time ' + timeClass + '">' +
                                timeText +
                            '</span>' +
                        '</div>';
                    listDiv.innerHTML += busItem;
                });
                
                hideElement(loadingP);
            });
        }

        /**
         * NEW: Function to render the tide graph using Chart.js (ES5 compatible)
         */
        function renderTideChart(labels, data) {
            var canvas = document.getElementById('tide-graph-canvas');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');

            var graphColor = '#38bdf8';
            var pointColor = '#7dd3fc';

            var gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, 'rgba(56, 189, 248, 0.3)');
            gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');

            if (tideChartInstance) {
                tideChartInstance.destroy();
            }

            tideChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tide Level',
                        data: data,
                        borderColor: graphColor,
                        backgroundColor: gradient,
                        fill: true,
                        borderWidth: 2,
                        pointBackgroundColor: pointColor,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 400
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            displayColors: false,
                            backgroundColor: 'rgba(30, 41, 59, 0.85)',
                            titleColor: '#e5e7eb',
                            bodyColor: '#e5e7eb',
                            borderColor: 'rgba(107, 114, 128, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(tooltipItems) {
                                    var title = tooltipItems[0].label;
                                    return 'Time: ' + title;
                                },
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' m';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time',
                                color: '#9ca3af',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(107, 114, 128, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 6,
                                callback: function(value, index, ticks) {
                                    return this.getLabelForValue(value); 
                                }
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tide Level (m)',
                                color: '#9ca3af',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(107, 114, 128, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value, index, ticks) {
                                    return value.toFixed(1) + ' m';
                                }
                            }
                        }
                    }
                }
            });
        }

        function fetchTides() {
            var now = new Date();
            var fortyEightHoursAgo = now.getTime() - (48 * 60 * 60 * 1000);
            var readingsUrl = 'https://environment.data.gov.uk/flood-monitoring/id/stations/' + EA_TIDE_STATION_ID + '/readings?_sorted&_limit=1000';
            
            var dataDiv = document.getElementById('tide-data');
            var loadingP = document.getElementById('tide-loading'); 
            var card = document.getElementById('tide-card').parentNode; // Get the .card-column
            var stationNameP = document.getElementById('tide-station-name');
            
            showElement(loadingP);
            hideElement(dataDiv);
            card.className = card.className.replace(' error-card-bg', '');
            
            stationNameP.textContent = 'Source: Tower Pier (Location ID ' + EA_TIDE_STATION_ID + ')';
            
            return fetchData(readingsUrl, "EA Tide data", { timeout: FETCH_TIMEOUT_MS })
                .then(function(result) {
                    if (result.error) {
                        hideElement(loadingP);
                        card.className += ' error-card-bg';
                        renderTideChart([], []); 
                        return;
                    }

                    var readings = result.items || [];
                    if (readings.length < 5) {
                         hideElement(loadingP);
                         card.className += ' error-card-bg';
                         renderTideChart([], []); 
                         return;
                    }
                    
                    var chartReadings = readings
                        .filter(function(r) { return typeof r.value === 'number' && new Date(r.dateTime).getTime() >= fortyEightHoursAgo; })
                        .slice()
                        .reverse();

                    var labels = chartReadings.map(function(r) { return formatChartLabel(r.dateTime); }); 
                    var data = chartReadings.map(function(r) { return r.value; });
                    
                    renderTideChart(labels, data);

                    var latestValue = readings[0]; 
                    var previousValue = readings[1];
                    
                    if (!latestValue || !previousValue || typeof latestValue.value !== 'number' || typeof previousValue.value !== 'number') {
                        hideElement(loadingP);
                        card.className += ' error-card-bg';
                        return;
                    }

                    var levelValue = latestValue.value;
                    var previousLevelValue = previousValue.value;
                    var levelValueFormatted = levelValue.toFixed(2);
                    var readingTime = formatDateTime(latestValue.dateTime);
                    
                    var directionText;
                    var directionColor;
                    var directionPath;
                    var tolerance = 0.01; 

                    if (levelValue > previousLevelValue + tolerance) {
                        directionText = "RISING";
                        directionColor = 'color: #4ade80;'; // text-green-400
                        directionPath = 'M10 17V3m0 0l-4 4m4-4l4 4';
                    } else if (levelValue < previousLevelValue - tolerance) {
                        directionText = "FALLING";
                        directionColor = 'color: #f87171;'; // text-red-400
                        directionPath = 'M10 3v14m0 0l-4-4m4 4l4-4';
                    } else {
                        directionText = "STEADY";
                        directionColor = 'color: #9ca3af;'; // text-gray-400
                        directionPath = 'M4 10h16';
                    }

                    document.getElementById('tide-level').textContent = levelValueFormatted;
                    document.getElementById('tide-status').innerHTML = 
                        directionText +
                        ' <svg style="width: 1.25rem; height: 1.25rem; display: inline-block; margin-left: 0.25rem; vertical-align: sub; ' + directionColor + '" fill="none" stroke="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + directionPath + '"/>' +
                        '</svg>';
                    
                    document.getElementById('tide-time').textContent = readingTime;

                    var tideIcon = document.getElementById('tide-icon');
                    tideIcon.style.color = '#60a5fa'; // text-blue-400
                    
                    hideElement(loadingP);
                    showElement(dataDiv);
                });
        }

        // --- MAIN DASHBOARD LOGIC (ES5) ---
        
        window.addEventListener('error', function(event) {
            console.error('Uncaught Error:', event.error);
        });
        
        // No 'unhandledrejection' in Safari 9, .catch() blocks are needed.

        function updateDashboard() {
            // Promise.all is supported
            var fetchPromises = [
                fetchWeather(),
                fetchTides(),
                fetchBusDepartures()
            ];

            // Use a simple polyfill for allSettled-like behavior (wait for all)
            Promise.all(fetchPromises)
                .then(function(results) {
                    // This will run after all promises have resolved (or one has rejected)
                    // In our case, fetch functions resolve with an error object, so they won't reject
                    document.getElementById('last-updated').textContent = 'Last updated: ' + formatTime(new Date());
                })
                .catch(function(err) {
                    // This will catch if a promise *rejects*, which ours shouldn't
                    // but it's good practice.
                    console.error("A critical error occurred:", err);
                    document.getElementById('last-updated').textContent = 'Last updated: ' + formatTime(new Date()) + ' (with errors)';
                });
        }


        window.onload = function () {
            // Manually hide data/show skeletons
            hideElement(document.getElementById('weather-data'));
            showElement(document.getElementById('weather-loading'));
            hideElement(document.getElementById('forecast-list-container'));
            showElement(document.getElementById('forecast-loading'));
            hideElement(document.getElementById('tide-data'));
            showElement(document.getElementById('tide-loading'));
            hideElement(document.getElementById('bus-list'));
            showElement(document.getElementById('bus-loading'));

            updateDashboard();
            updateTimeAndDate(); 
            setInterval(updateTimeAndDate, 1000); 
            setInterval(updateDashboard, 60000); 
        }
    </script>
</body>
</html>
